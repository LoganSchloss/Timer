<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Bluetooth</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; flex-direction: column; }
        .container { text-align: center; background: white; padding: 2.5rem; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 85%; max-width: 400px; }
        #display { font-size: 3.5rem; font-weight: bold; margin-bottom: 2rem; color: #333; font-variant-numeric: tabular-nums; }
        #btBtn { background-color: #007bff; color: white; border: none; padding: 18px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.1rem; }
        small { font-size: 2rem; color: #888; }
        #status { margin-top: 15px; font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cronometro BLE</h1>
        <div id="display">00:00:00.<small>00</small></div>
        <button id="btBtn">ðŸ”µ CONNETTI BLUETOOTH</button>
        <p id="status">Stato: Disconnesso</p>
    </div>

    <script>
        let startTime, elapsedTime = 0, timerInterval;
        const display = document.getElementById('display');
        const btBtn = document.getElementById('btBtn');
        const status = document.getElementById('status');

        function timeToString(time) {
            let hh = Math.floor(time / 3600000).toString().padStart(2, "0");
            let mm = Math.floor((time % 3600000) / 60000).toString().padStart(2, "0");
            let ss = Math.floor((time % 60000) / 1000).toString().padStart(2, "0");
            let centesimi = Math.floor((time % 1000) / 10).toString().padStart(2, "0");
            return `${hh}:${mm}:${ss}.<small>${centesimi}</small>`;
        }

        function toggleTimer() {
            if (!timerInterval) {
                startTime = Date.now() - elapsedTime;
                timerInterval = setInterval(() => {
                    elapsedTime = Date.now() - startTime;
                    display.innerHTML = timeToString(elapsedTime);
                }, 10);
            } else {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        btBtn.onclick = async () => {
            try {
                status.innerText = "Ricerca in corso...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TimerESP32' }],
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                const characteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
                
                await characteristic.startNotifications();
                status.innerText = "Stato: CONNESSO âœ…";
                btBtn.style.display = "none";

                characteristic.addEventListener('characteristicvaluechanged', () => {
                    toggleTimer();
                });
            } catch (error) {
                status.innerText = "Errore: " + error;
            }
        };
    </script>
</body>
</html>
